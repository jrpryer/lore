<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Ydi-Kaari System – Gyroscopic Orbits</title>
<style>
  body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  #info{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.65);padding:10px;border-radius:4px;font-size:13px;line-height:1.35em;z-index:100}
  #ui{position:absolute;top:10px;right:10px;z-index:100;display:flex;gap:4px;flex-wrap:wrap}
  #upload{position:absolute;bottom:10px;left:10px;z-index:100;background:rgba(0,0,0,.6);padding:6px;border-radius:4px;font-size:12px}
  button,select{padding:6px 10px;background:#222;border:none;border-radius:3px;color:#fff;cursor:pointer}
  button:hover,select:hover{background:#444}
</style></head><body>
<div id="info"></div>
<div id="ui">
  <button onclick="togglePause()">Pause/Play</button>
  <button onclick="resetTime()">Reset</button>
  <div style="display:flex;align-items:center;gap:2px;background:#222;border-radius:3px;padding:2px">
    <button onclick="decreaseSpeed()" style="padding:6px 8px">◀</button>
    <span id="speedDisp" style="padding:0 8px;min-width:50px;text-align:center">0.03x</span>
    <button onclick="increaseSpeed()" style="padding:6px 8px">▶</button>
  </div>
  <button onclick="toggleCam()">Camera: <span id="camMode">Auto</span></button>
  <select id="planetSelect"><option value="-1">(system view)</option></select>
</div>
<label id="upload"><span id="uploadText"></span> <input type="file" id="fileInput" accept="image/png"></label>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>
<script>
/******************** CELESTIAL NAMES - EDIT HERE ********************/
const NAMES = {
  planets: {
    p1: "Lämmrus",      // Inner flick-flame
    p2: "Abythras",     // Ash-red wanderer
    p3: "Echni",        // Emerald bloom
    p4: "Kanyiirah",    // Ocean world
    p5: "Yggrāhkærn",   // Distant shard
    p6: "Hræth"         // Violet giant
  },
  moons: {
    p2m1: "Ghaal",      // Abythras' moon
    p4m1: "Roida",      // Kanyiirah's moon 1
    p4m2: "Valya",      // Kanyiirah's moon 2
    p6m1: "Muérai"      // Hræth's moon
  }
};

/******************** CONFIG (eccentric + precess) ********************/
const systemBodies=[
 {
  /* Inner flick-flame */
  name:NAMES.planets.p1,
  color:0xD4C090, distance:6, radius:0.20, period:8,  tilt:30, ecc:0.28,
  nodeRate:3.5e-3,            // ≈ one full swivel every 6-7 h
  wobble:{ amp:65, rate:1.2e-3 },  // ±65° nod, ~5 h period
  moons:[]
},
{
  /* Ash-red wanderer */
  name:NAMES.planets.p2,
  color:0x9B7560, distance:9, radius:0.34, period:13.3, tilt:-5, ecc:0.35,
  nodeRate:2.8e-3,
  wobble:{ amp:60, rate:1.0e-3 },
  moons:[{name:NAMES.moons.p2m1, color:0xB0B0B0, distance:1.1, radius:0.10, period:20}]
},
{
  /* Emerald bloom */
  name:NAMES.planets.p3,
  color:0x8A9570, distance:12, radius:0.23, period:19.3, tilt:13, ecc:0.40,
  nodeRate:2.4e-3,
  wobble:{ amp:55, rate:9e-4 },
  glowColor:0xA0B080, moons:[]
},
{
  /* Ocean world (what you just tested) */
  name:NAMES.planets.p4,
  color:0x7090A8, distance:16, radius:0.38, period:26.1, tilt:0, ecc:0.30,
  nodeRate:2.0e-3,
  wobble:{ amp:60, rate:1.0e-3 },
  glowColor:0x90B0C8,
  moons:[
    {name:NAMES.moons.p4m1, color:0x9B6B70, distance:1.8, radius:0.08, period:16.8},
    {name:NAMES.moons.p4m2, color:0xA080B0, distance:2.8, radius:0.05, period:83.28}
  ]
},
{
  /* Distant shard */
  name:NAMES.planets.p5,
  color:0x909090, distance:20, radius:0.21, period:33.5, tilt:-45, ecc:0.1,
  nodeRate:1.6e-3,
  wobble:{ amp:50, rate:8e-4 },
  moons:[]
},
{
  /* Violet giant */
  name:NAMES.planets.p6,
  color:0xC178E3, distance:30, radius:1.20, period:50.2, tilt:27, ecc:0.3,
  nodeRate:1.2e-3,
  wobble:{ amp:45, rate:7e-4 },
  glowColor:0xE9B6FF,
  moons:[{name:NAMES.moons.p6m1, color:0x7090A8, distance:3.2, radius:0.12, period:40}]
}
];

/******************** GLOBALS ********************/
let scene,camera,renderer,controls;
let autoCam=true,camRadius=55,sel=-1;
let t=0,paused=false,speedIdx=1;const speeds=[0,0.03,0.1,0.5,1,10];
const meta=[];let kanyiirahMesh,landOverlay;
const v=new THREE.Vector3(),TAU=2*Math.PI;
const labels=[];
let cometBelt;

/******************** INIT ********************/
init();animate();
function init(){
  scene=new THREE.Scene();scene.background=new THREE.Color(0x000011);
  
  /* Create starfield skybox */
  createStarfield();
  camera=new THREE.PerspectiveCamera(28,innerWidth/innerHeight,0.1,400);
  camera.position.set(0,16,camRadius);
  renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(innerWidth,innerHeight);document.body.appendChild(renderer.domElement);
  controls=new THREE.OrbitControls(camera,renderer.domElement);
  controls.enableDamping=true;
  controls.enabled=false;
  controls.minDistance=5;
  controls.maxDistance=150;

  const light1 = new THREE.PointLight(0xffffff,0.2);
  light1.position.set(0.8,0,0);
  scene.add(light1);
  
  const light2 = new THREE.PointLight(0xffffff,0.3);
  light2.position.set(-0.8,0,0);
  scene.add(light2);
  
  scene.add(new THREE.AmbientLight(0xffffff,0.4));
  
  const hemiLight = new THREE.HemisphereLight(0x88aaff,0x202040,0.45);
  hemiLight.position.set(0,20,0);
  scene.add(hemiLight);

  const sunGeo=new THREE.SphereGeometry(0.5,32,32);
  const sun1 = new THREE.Mesh(sunGeo,new THREE.MeshBasicMaterial({color:0xffffff}));
  sun1.position.set(0.8,0,0);
  scene.add(sun1);
  
  const sun2 = new THREE.Mesh(sunGeo,new THREE.MeshBasicMaterial({color:0xffffff}));
  sun2.position.set(-0.8,0,0);
  scene.add(sun2);
  
  /* Create labels for suns */
  const solLabel = createLabel('Sol');
  solLabel.style.fontSize = '12px';
  solLabel.style.fontWeight = 'bold';
  labels.push({mesh:sun1,label:solLabel,offset:0.7});
  
  const anLabel = createLabel('An');
  anLabel.style.fontSize = '12px';
  anLabel.style.fontWeight = 'bold';
  labels.push({mesh:sun2,label:anLabel,offset:0.7});

  systemBodies.forEach(buildBody);
  
  /* Create comet belt */
  createCometBelt();

  window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
  document.getElementById('fileInput').addEventListener('change',e=>loadOverlay(e.target.files[0]));
  document.getElementById('uploadText').textContent = `Land-map PNG for ${NAMES.planets.p4}`;
  populateSelector();
}

/******************** STARFIELD SKYBOX ********************/
function createStarfield(){
  // Create star texture
  const canvas = document.createElement('canvas');
  canvas.width = 4096;
  canvas.height = 4096;
  const ctx = canvas.getContext('2d');
  
  // Dark space background
  ctx.fillStyle = '#000011';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Add stars
  for(let i = 0; i < 6000; i++){
    const x = Math.random() * canvas.width;
    const y = Math.random() * canvas.height;
    const radius = Math.random() * 0.8 + 0.2;
    const brightness = Math.random() * 0.6 + 0.1;
    
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, TAU);
    ctx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
    ctx.fill();
  }
  
  // Add some colorful stars
  for(let i = 0; i < 400; i++){
    const x = Math.random() * canvas.width;
    const y = Math.random() * canvas.height;
    const radius = Math.random() * 1.2 + 0.3;
    const colors = ['255,200,200', '200,200,255', '255,255,200', '200,255,255'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    const brightness = 0.3 + Math.random() * 0.4;
    
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, TAU);
    ctx.fillStyle = `rgba(${color}, ${brightness})`;
    ctx.fill();
  }
  
  // Add nebula clouds
  for(let i = 0; i < 5; i++){
    const x = Math.random() * canvas.width;
    const y = Math.random() * canvas.height;
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, 150 + Math.random() * 150);
    gradient.addColorStop(0, 'rgba(150, 100, 200, 0.05)');
    gradient.addColorStop(0.5, 'rgba(100, 50, 150, 0.02)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  
  const texture = new THREE.CanvasTexture(canvas);
  
  // Create large sphere for skybox
  const skyGeo = new THREE.SphereGeometry(200, 32, 32);
  const skyMat = new THREE.MeshBasicMaterial({
    map: texture,
    side: THREE.BackSide, // Render inside of sphere
    fog: false
  });
  
  const skybox = new THREE.Mesh(skyGeo, skyMat);
  scene.add(skybox);
}

/******************** BUILD ONE PLANET ********************/
function createLabel(text){
  const div=document.createElement('div');
  div.className='label';
  div.textContent=text;
  div.style.position='absolute';
  div.style.color='#fff';
  div.style.fontSize='11px';
  div.style.fontFamily='Arial,sans-serif';
  div.style.pointerEvents='none';
  div.style.textShadow='0 0 3px #000,0 0 6px #000';
  div.style.opacity='0.8';
  div.style.whiteSpace='nowrap';
  document.body.appendChild(div);
  return div;
}

function buildBody(b){
  /* nodePivot → rotates slowly around Y (precession of nodes) */
  const nodePivot=new THREE.Object3D();scene.add(nodePivot);

  /* tiltPivot → constant inclination + nutation wobble */
  const tiltPivot=new THREE.Object3D();nodePivot.add(tiltPivot);

  /* ellipse axes */
  b.a=b.distance;
  b.b=b.distance*(1-b.ecc);

  /* planet mesh */
  let planetMat;
  if(b.name===NAMES.planets.p6){
    /* Gas giant with banded atmosphere */
    const canvas = document.createElement('canvas');
    canvas.width = 512; canvas.height = 256;
    const ctx = canvas.getContext('2d');
    
    /* Create atmospheric bands with muted gradient */
    const gradient = ctx.createLinearGradient(0, 0, 0, 256);
    gradient.addColorStop(0.0, '#E8D4E0');   // Light pinkish
    gradient.addColorStop(0.15, '#D9C0D0');  // Soft mauve
    gradient.addColorStop(0.25, '#C8A8C8');  // Muted purple
    gradient.addColorStop(0.35, '#E0C8D8');  // Pink-lavender
    gradient.addColorStop(0.45, '#B090B8');  // Deeper purple
    gradient.addColorStop(0.55, '#C8A0C0');  // Mid purple-pink
    gradient.addColorStop(0.65, '#D8B8D0');  // Light purple
    gradient.addColorStop(0.75, '#C090B8');  // Purple band
    gradient.addColorStop(0.85, '#E8D0E0');  // Very light pink
    gradient.addColorStop(1.0, '#D0B0C8');   // Soft purple
    
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, 512, 256);
    
    /* Add subtle turbulence */
    const imageData = ctx.getImageData(0, 0, 512, 256);
    const data = imageData.data;
    for(let i = 0; i < data.length; i += 4) {
      const turbulence = (Math.random() - 0.5) * 10; // Reduced from 20
      data[i] = Math.max(0, Math.min(255, data[i] + turbulence));
      data[i+1] = Math.max(0, Math.min(255, data[i+1] + turbulence));
      data[i+2] = Math.max(0, Math.min(255, data[i+2] + turbulence));
    }
    ctx.putImageData(imageData, 0, 0);
    
    const texture = new THREE.CanvasTexture(canvas);
    planetMat = new THREE.MeshLambertMaterial({map: texture});
    
    /* Store for rotation */
    b._isGasGiant = true;
    b._rotationRate = 0.0008; // Fast rotation typical of gas giants
  } else {
    planetMat = new THREE.MeshLambertMaterial({color:b.color});
  }
  
  const planet=new THREE.Mesh(new THREE.SphereGeometry(b.radius,64,64), planetMat);
  tiltPivot.add(planet);b.mesh=planet;
  
  /* Create label for planet */
  const planetLabel=createLabel(b.name);
  labels.push({mesh:planet,label:planetLabel,offset:b.radius+0.5});

  if(b.glowColor){
    /* Enhanced atmosphere for gas giant */
    if(b.name===NAMES.planets.p6){
      /* Multiple atmospheric layers - much more subtle */
      planet.add(new THREE.Mesh(new THREE.SphereGeometry(b.radius*1.05,32,32),
          new THREE.MeshBasicMaterial({color:0xE0C8E0,transparent:true,opacity:.15,
                                       blending:THREE.AdditiveBlending,depthWrite:false})));
      planet.add(new THREE.Mesh(new THREE.SphereGeometry(b.radius*1.12,32,32),
          new THREE.MeshBasicMaterial({color:0xC8B0D0,transparent:true,opacity:.10,
                                       blending:THREE.AdditiveBlending,depthWrite:false})));
    } else {
      planet.add(new THREE.Mesh(new THREE.SphereGeometry(b.radius*1.15,32,32),
          new THREE.MeshBasicMaterial({color:b.glowColor,transparent:true,opacity:.25,
                                       blending:THREE.AdditiveBlending,depthWrite:false})));
    }
  }
  if(b.name===NAMES.planets.p4) kanyiirahMesh=planet;

  /* ring */
  const ringPts=[];for(let i=0;i<=256;i++){const ang=i/256*TAU;ringPts.push(new THREE.Vector3(b.a*Math.cos(ang),0,b.b*Math.sin(ang))); }
  tiltPivot.add(new THREE.Line(new THREE.BufferGeometry().setFromPoints(ringPts),
      new THREE.LineBasicMaterial({color:0x666666,transparent:true,opacity:.25})));

  /* moons */
  (b.moons||[]).forEach(m=>{
    /* Moon's own node pivot for precession */
    const moonNodePivot = new THREE.Object3D();
    planet.add(moonNodePivot);
    
    /* Moon's tilt pivot for wobble */
    const moonTiltPivot = new THREE.Object3D();
    moonNodePivot.add(moonTiltPivot);
    
    /* Store pivots for animation */
    m._nodePivot = moonNodePivot;
    m._tiltPivot = moonTiltPivot;
    
    /* Set moon's orbital parameters */
    m.tilt = m.tilt || (Math.random() * 40 - 20); // Random tilt if not specified
    m.nodeRate = m.nodeRate || (4e-3 + Math.random() * 2e-3); // Faster than planets
    m.wobble = m.wobble || { amp: 30 + Math.random() * 20, rate: 1.5e-3 + Math.random() * 5e-4 };
    
    /* Moon orbit container */
    const mp=new THREE.Object3D();
    moonTiltPivot.add(mp);
    const moon=new THREE.Mesh(new THREE.SphereGeometry(m.radius,32,32),new THREE.MeshLambertMaterial({color:m.color}));
    moon.position.x=m.distance;
    mp.add(moon);
    m._pivot=mp;
    
    /* Create label for moon */
    const moonLabel=createLabel(m.name);
    moonLabel.style.fontSize='9px';
    moonLabel.style.opacity='0.6';
    labels.push({mesh:moon,label:moonLabel,offset:m.radius+0.3});
    
    /* Create dashed orbital line for moon */
    const moonRingPts=[];
    const segments=64;
    for(let i=0;i<=segments;i++){
      const ang=i/segments*TAU;
      moonRingPts.push(new THREE.Vector3(m.distance*Math.cos(ang),0,m.distance*Math.sin(ang)));
    }
    const moonOrbitGeo = new THREE.BufferGeometry().setFromPoints(moonRingPts);
    const moonOrbitMat = new THREE.LineDashedMaterial({
      color:m.color,
      transparent:true,
      opacity:0.3,
      dashSize:0.15,
      gapSize:0.15
    });
    const moonOrbit = new THREE.Line(moonOrbitGeo, moonOrbitMat);
    moonOrbit.computeLineDistances(); // Required for dashed lines
    moonTiltPivot.add(moonOrbit);
  });

  /* cache */
  b._phase=Math.random()*TAU;
  meta.push({b,nodePivot,tiltPivot});
}

/******************** COMET BELT ********************/
function createCometBelt(){
  const innerRadius = 22; // Just beyond Yggrāhkærn
  const outerRadius = 27; // Just before Hræth
  const beltHeight = 3;   // Vertical spread
  const cometCount = 150;
  
  const geometry = new THREE.BufferGeometry();
  const positions = [];
  const sizes = [];
  const velocities = [];
  const orbits = [];
  
  for(let i=0; i<cometCount; i++){
    // Random position in belt
    const r = innerRadius + Math.random() * (outerRadius - innerRadius);
    const theta = Math.random() * TAU;
    const y = (Math.random() - 0.5) * beltHeight;
    
    positions.push(r * Math.cos(theta), y, r * Math.sin(theta));
    sizes.push(Math.random() * 0.08 + 0.02); // Varied comet sizes
    
    // Store orbital parameters
    velocities.push(0.5 + Math.random() * 0.5); // Varied speeds
    orbits.push({
      radius: r,
      angle: theta,
      height: y,
      speed: (0.02 + Math.random() * 0.03) / r, // Slower for outer comets
      wobble: Math.random() * 0.5,
      wobbleSpeed: Math.random() * 0.001
    });
  }
  
  geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
  geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
  
  // Comet material with glow
  const material = new THREE.PointsMaterial({
    size: 0.15,
    sizeAttenuation: true,
    color: 0x60C0FF,  // Changed from 0xE0E0FF - now cyan-blue
    transparent: true,
    opacity: 0.9,     // Increased from 0.8
    blending: THREE.AdditiveBlending,
    vertexColors: false
  });
  
  cometBelt = new THREE.Points(geometry, material);
  cometBelt.userData.orbits = orbits;
  scene.add(cometBelt);
  
  // Add subtle dust cloud
  const dustGeometry = new THREE.BufferGeometry();
  const dustPositions = [];
  const dustCount = 500;
  
  for(let i=0; i<dustCount; i++){
    const r = innerRadius + Math.random() * (outerRadius - innerRadius);
    const theta = Math.random() * TAU;
    const y = (Math.random() - 0.5) * beltHeight * 1.5;
    dustPositions.push(r * Math.cos(theta), y, r * Math.sin(theta));
  }
  
  dustGeometry.setAttribute('position', new THREE.Float32BufferAttribute(dustPositions, 3));
  
  const dustMaterial = new THREE.PointsMaterial({
    size: 0.03,
    sizeAttenuation: true,
    color: 0x4080AA,  // Changed from 0x9090AA - now blue-tinted
    transparent: true,
    opacity: 0.3,     // Increased from 0.2
    blending: THREE.AdditiveBlending
  });
  
  const dust = new THREE.Points(dustGeometry, dustMaterial);
  dust.userData.isDust = true;
  cometBelt.add(dust);
}

/******************** LAND-MAP (unchanged) ********************/
function loadOverlay(file){if(!file)return;const r=new FileReader();r.onload=e=>applyOverlay(e.target.result);r.readAsDataURL(file);}
function applyOverlay(url){
  if(!kanyiirahMesh)return;
  if(landOverlay){kanyiirahMesh.remove(landOverlay.l);kanyiirahMesh.remove(landOverlay.r);}
  const img=new Image();
  img.onload=()=>{
    const S=img.height;
    const mk=o=>{
      const c=document.createElement('canvas');c.width=S;c.height=S;
      const ctx=c.getContext('2d');ctx.drawImage(img,o,0,S,S,0,0,S,S);
      const d=ctx.getImageData(0,0,S,S),px=d.data;
      for(let i=0;i<px.length;i+=4){const r=px[i],g=px[i+1],b=px[i+2];px[i+3]=(b>r&&b>g)?0:210;px[i]=63;px[i+1]=161;px[i+2]=63;}
      ctx.putImageData(d,0,0);return new THREE.CanvasTexture(c);
    };
    const r0=kanyiirahMesh.geometry.parameters.radius*1.001;
    const hemiL=new THREE.Mesh(new THREE.SphereGeometry(r0,64,64,0,Math.PI),
        new THREE.MeshBasicMaterial({map:mk(0),transparent:true,depthWrite:false}));
    const hemiR=new THREE.Mesh(new THREE.SphereGeometry(r0,64,64,Math.PI,Math.PI),
        new THREE.MeshBasicMaterial({map:mk(S),transparent:true,depthWrite:false}));
    kanyiirahMesh.add(hemiL,hemiR);landOverlay={l:hemiL,r:hemiR};
  };img.src=url;
}

/******************** ANIMATE ******************************/
function animate(){
  requestAnimationFrame(animate);
  if(!paused && speeds[speedIdx]>0)t+=0.1*speeds[speedIdx];

  meta.forEach(o=>{
    const b=o.b, np=o.nodePivot, tp=o.tiltPivot;

    /* node precession (gyroscopic swivel) */
    np.rotation.y = t * b.nodeRate;

    /* inclination + small nutation */
    const base = THREE.MathUtils.degToRad(b.tilt);
    tp.rotation.x = base + THREE.MathUtils.degToRad(b.wobble.amp)*Math.sin(t*b.wobble.rate);

    /* planet position in its own tilted, precessing plane */
    const ang = (t/b.period)*TAU + b._phase;
    b.mesh.position.set(b.a*Math.cos(ang),0,b.b*Math.sin(ang));
    
    /* Gas giant rotation */
    if(b._isGasGiant) {
      b.mesh.rotation.y += b._rotationRate * speeds[speedIdx];
    }

    /* moons */
    (b.moons||[]).forEach(m=>{
      /* Apply moon's own precession and wobble */
      if(m._nodePivot) m._nodePivot.rotation.y = t * m.nodeRate;
      if(m._tiltPivot) {
        const moonBase = THREE.MathUtils.degToRad(m.tilt);
        m._tiltPivot.rotation.x = moonBase + THREE.MathUtils.degToRad(m.wobble.amp)*Math.sin(t*m.wobble.rate);
      }
      m._pivot.rotation.y=t/m.period*TAU;
    });
  });
  
  /* Animate comet belt */
  if(cometBelt && speeds[speedIdx]>0){
    const positions = cometBelt.geometry.attributes.position.array;
    const orbits = cometBelt.userData.orbits;
    
    for(let i=0; i<orbits.length; i++){
      const o = orbits[i];
      o.angle += o.speed * speeds[speedIdx];
      
      // Add slight vertical wobble
      const wobbleY = o.height + Math.sin(t * o.wobbleSpeed) * o.wobble;
      
      positions[i*3] = o.radius * Math.cos(o.angle);
      positions[i*3+1] = wobbleY;
      positions[i*3+2] = o.radius * Math.sin(o.angle);
    }
    
    cometBelt.geometry.attributes.position.needsUpdate = true;
    
    // Slow rotation of dust cloud
    cometBelt.children.forEach(child => {
      if(child.userData.isDust) {
        child.rotation.y += 0.0001 * speeds[speedIdx];
      }
    });
  }

  autoCam?autoFollow():controls.update();
  updateLabels();
  hud();
  renderer.render(scene,camera);
}

/******************** UPDATE LABELS ******************************/
function updateLabels(){
  labels.forEach(l=>{
    l.mesh.getWorldPosition(v);
    v.project(camera);
    const x=(v.x*0.5+0.5)*innerWidth;
    const y=(-v.y*0.5+0.5)*innerHeight;
    l.label.style.left=(x-l.label.offsetWidth/2)+'px';
    l.label.style.top=(y-l.offset*20)+'px';
    l.label.style.display=v.z<1?'block':'none';
  });
}

/******************** CAMERA ******************************/
function autoFollow(){
  if(sel>=0){
    systemBodies[sel].mesh.getWorldPosition(v);
    camera.position.x=v.x+Math.cos(t*0.004)*camRadius*0.4;
    camera.position.z=v.z+Math.sin(t*0.004)*camRadius*0.4;
    camera.position.y=v.y+camRadius*0.15;
    camera.lookAt(v);
  }else{
    camera.position.x=Math.cos(t*0.004)*camRadius;
    camera.position.z=Math.sin(t*0.004)*camRadius;
    camera.lookAt(0,0,0);
  }
}
function focus(b){b.mesh.getWorldPosition(v);controls.target.copy(v);controls.update();}

/******************** HUD ******************************/
function hud(){
  info.innerHTML=`<strong>Ydi-Kaari System</strong><br>Time ${t.toFixed(1)} h<br>`+
    systemBodies.map(b=>`${b.name}: ${((t/b.period)%1*100).toFixed(1)} %`).join('<br>');
}

/******************** UI ******************************/
const spd=document.getElementById('speedDisp'),camTxt=document.getElementById('camMode');
function populateSelector(){const s=document.getElementById('planetSelect');systemBodies.forEach((b,i)=>{const o=document.createElement('option');o.value=i;o.textContent=b.name;s.appendChild(o);});
s.onchange=e=>{sel=+e.target.value;controls.enabled=!autoCam;if(sel>=0)focus(systemBodies[sel]);else{controls.target.set(0,0,0);controls.update();}};}
function togglePause(){paused=!paused;}
function resetTime(){t=0;}
function decreaseSpeed(){
  if(speedIdx>0){
    speedIdx--;
    updateSpeedDisplay();
  }
}
function increaseSpeed(){
  if(speedIdx<speeds.length-1){
    speedIdx++;
    updateSpeedDisplay();
  }
}
function updateSpeedDisplay(){
  if(speeds[speedIdx]===0){
    spd.textContent='Paused';
    spd.style.color='#ff9999';
  }else{
    spd.textContent=speeds[speedIdx]+'x';
    spd.style.color='#fff';
  }
}
function toggleCam(){autoCam=!autoCam;camTxt.textContent=autoCam?'Auto':'Manual';controls.enabled=!autoCam;if(autoCam&&sel>=0)focus(systemBodies[sel]);}
</script></body></html>